<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../assets/logoEscudo.png" type="image/x-icon">

    <title>Security Bank | Controle Acesso</title>

    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/navbarDash.css">
    <link rel="stylesheet" href="../css/dashboards.css">
    <link rel="stylesheet" href="../css/GerenciarAcesso.css">
    <script src="../js/sessao.js"></script>
    <script src="../js/alerta.js"></script>
    <script src="alertasDash.js"></script>


    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body onload="ContasAdministradas(), Plano(),VerificarServidor(), percentCPU(),percentRAM(),percentDISK()">

    <div class="janela">
        <div class="header-left">
            <div class="logo">
                <img src="../assets/logoBranca.png" alt="">
            </div>

            <div class="opcao">
                <span>Ol√°, <b id="nomeAdm">Nome ADM</b></span>
            </div>

            <div id="nivelACesso" class="TipoAcesso">
                <span>Administrador</span>
            </div>

            <div class="opcoes">
                <a href="dashboard.html">
                    <img src="../assets/home.png" alt="">
                    <span>Home</span>
                </a>
            </div>
            <div class="opcoesServidores">
                <a href="servidoresDash.html">
                    <img src="../assets/servidor.png" alt="">
                    <span>Servidores</span>
                </a>
                <div id="opcoesServidores-content" class="opcoesServidores-content">


                </div>
            </div>

            <div class="opcoes">
                <a href="">
                    <img src="../assets/servidor.png    " alt="">
                    <span>Vis√µes</span>
                </a>
                <!-- <div class="opcoesServidores-content">
                    <a href="alertas.html">Vis√£o 1</a>
                    <a href="alertas.html">Vis√£o 2</a>
                </div> -->
            </div>
            <!-- <div class="opcoes">
                <a href="">
                    <img src="../assets/imgs/servdores.png" alt="">
                    <span>Vis√£o Gabriel</span>
                </a>
            </div>
            <div class="opcoes">
                <a href="">
                    <img src="../assets/imgs/servdores.png" alt="">
                    <span>Vis√£o Gustavo</span>
                </a>
            </div>
            <div class="opcoes">
                <a href="">
                    <img src="../assets/imgs/servdores.png" alt="">
                    <span>Vis√£o Marcela</span>
                </a>
            </div>
            <div class="opcoes">
                <a href="">
                    <img src="../assets/imgs/servdores.png" alt="">
                    <span>Vis√£o Nat√°lia</span>
                </a>
            </div>
            <div class="opcoes">
                <a href="">
                    <img src="../assets/imgs/servdores.png" alt="">
                    <span>Vis√£o Pedro</span>
                </a>
            </div> -->
            <div class="opcoes">
                <a href="alertas.html">
                    <img src="../assets/alerta.png" alt="">
                    <span>Alertas</span>
                </a>
            </div>
            <div class="opcoes">
                <a href="perfil.html">
                    <img src="../assets/perfil.png" alt="">
                    <span>Perfil</span>
                </a>
            </div>
            <div id="gerenciarAcesso" class="opcoes localizacao">
                <a href="GerenciarAcesso.html">
                    <img src="../assets/controle.png" alt="">
                    <span>Controle de acesso</span>
                </a>
            </div>
            <div class="opcoes">
                <a href="suporteDash.html">
                    <img src="../assets/ajuda.png" alt="">
                    <span>Ajuda</span>
                </a>
            </div>
            <div class="opcoes">
                <a href="metricasDash.html">
                    <img src="../assets/metricas.png" alt="">
                    <span>M√©tricas</span>
                </a>
            </div>
            <!-- <div class="opcoes">
                <a href="recFacial.html">
                    <img src="../assets/imgs/recFacial.png" alt="">
                    <span>Reconhecimento Facial</span>
                </a>
            </div> -->
            <div class="linha">
                <span></span>
            </div>
            <div class="opcoes">
                <a href="../index.html">
                    <img src="../assets/logout.png" alt="">
                    <span onclick="limparSessonStorage()">Logout</span>
                </a>
            </div>
        </div>

        <div class="dashGerenciar">
            <div id="alerta">
            </div>

            <div class="btns-dash" id="btnAquario">
                <!-- O gr√°fico √© chamado de acordo com o id (fk_aquario) do banco  -->
            </div>
            <div id="graficos">
            </div>
            <div class="headerGerenciar">
                <h1 class="tituloGerenciar">Controle de Acesso</h1>
                <div id="nomePlano" class="divPlanoUsuario"><span id="planoUsuario">Plano Premium</span></div>
            </div>
            <div class="ativoDesativo">
                <div class="blocoCpu">
                    <div class="bolaVerde">
                        <img src="../assets/checkComponentes.png" class="imgComponentes" alt="">
                    </div>
                    <span class="legComponentes">CPU</span>
                </div>
                <div class="blocoDisco">
                    <div class="bolaVerde">
                        <img src="../assets/checkComponentes.png" class="imgComponentes" alt="">
                    </div>
                    <span class="legComponentes">Disco</span>
                </div>
                <div class="blocoRAM">
                    <div class="bolaVerde">
                        <img src="../assets/checkComponentes.png" class="imgComponentes" alt="">
                    </div>
                    <span class="legComponentes">RAM</span>
                </div>
                <div class="blocoRede">
                    <div class="bolaVerde">
                        <img src="../assets/checkComponentes.png" class="imgComponentes" alt="">
                    </div>
                    <span class="legComponentes">Rede</span>
                </div>
                <div class="blocoUsb">
                    <div class="bolaVerde">
                        <img src="../assets/checkComponentes.png" class="imgComponentes" alt="">
                    </div>
                    <span class="legComponentes">USB</span>
                </div>
            </div>

            <div class="fundo">
                <div class="botoesControle">
                    <div onclick="adicionar()" class="boxAdicionarServico">
                        <n class="adicione">Adicione um Servidor ao Monitoramento</n>
                        <!-- <img src="../assets/ü¶Ü icon _add circle outline_.png" alt="" class="addIMG"> -->
                    </div>
                    <div onclick="controleData()" class="boxAdicionarServico">
                        <n class="adicione">Controle da Data de Validade</n>
                        <!-- <img src="../assets/ü¶Ü icon _add circle outline_.png" alt="" class="addIMG"> -->
                    </div>
                </div>

                <div class="fundoContas">
                    <h1 class="TittleContas">Contas Administradas</h1>
                    <div class="linhaSu">
                        <h2 class="SubtittleContas">Conta</h2>
                        <h2 class="SubtittleContas">Nivel Acesso</h2>
                        <h2 class="SubtittleContas">Edi√ß√£o</h2>
                    </div>
                    <div id="colocar" class="espaco">
                        <div id="dadosMostrar" class="dadosUsuarios">
                            <a id="MostrarEmail" class="emailControle"></a>
                            <span id="MostrarNivel" class="nivelAcesso"></span>

                            <div class="edicaoGerenciamentoContas">
                                <button class="botaoEditarAcesso" onclick="EditarAcesso(i)">Editar</button>
                                <button class="botaoEditarAcesso" onclick="ExcluirConta(i)">Excluir</button>
                            </div>
                            <!-- <div class="imgsContas">
                                <img class="imgEdicaoGerenciar" src="../assets/ü¶Ü icon _Edit_.png" alt="" class="alterar">
                                <img src="../assets/ü¶Ü icon _Delete_.png" alt="" class="deletar"><span>editar</span>
                            </div> -->
                            <!-- <span>Editar</span> -->
                        </div>
                        <div class="linhaEspacamento"><span></span></div>
                    </div>

                    <div class="cabecario"></div>
                </div>
                <div class="rodapeDash">
                    <div class="itens">
                        <div class="blocos">
                            <h1>Security Bank</h1>
                            <h4>TECH & SOLUTIONS</h4>
                        </div>
                        <div class="blocos">
                            <span><b>Telefone:</b>(11)40028922</span>
                            <br>
                            <span><b>Email:</b>SC.contato.2023@gmail.com</span>
                        </div>
                        <div class="blocos">
                            <span><b>Endere√ßo:</b>Rua Haddock Lobo, 595 -<br>
                                Cerqueira C√©sar, S√£o Paulo - SP,<br>
                                01414-001</span>
                        </div>
                    </div>
                    <div class="direitos">&copy; 2023 copyrights by SecurityBank. All Rights Reserved</div>
                </div>
            </div>
        </div>



</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>

<script>

    var escalonamentoFunc = sessionStorage.FKESCALONAMENTO

    if (escalonamentoFunc != 1) {
        nivelACesso.innerHTML = `<span>Funcion√°rio</span>`
        var divAcesso = document.getElementById("gerenciarAcesso")
        divAcesso.style.display = 'none';
    }

    var vetor = [];
    var selectedServer;// Declarar idUsuario fora do escopo da fun√ß√£o

    function exibirServidoresUsuario() {
        var server = JSON.parse(sessionStorage.servidor);
        console.log("Conte√∫do da sessionStorage.servidor: ", server); // Verificar o conte√∫do de sessionStorage.servidor
        var selectServidores = document.getElementById("opcoesServidores-content");
        selectServidores.innerHTML = ""; // Limpar as op√ß√µes existentes para evitar duplicatas
        server.forEach(element => {
            var button = document.createElement('button');
            button.textContent = element.apelido;
            button.addEventListener("click", function (event) {
                event.preventDefault();
                selectedServer = element.idServidor;
                vetor.push(selectedServer);
                console.log("Valor de selectedServer: ", selectedServer); // Mostra o valor atualizado de selectedServer

                console.log("Valor de idUsuario: ", idUsuario); // Mostra o valor de idUsuario atualizado
                inserir(selectedServer); // Chamar a fun√ß√£o inserir com o ID do servidor
                window.location.href = "servidoresDash.html"; // Redirecionar para a p√°gina desejada
            });
            button.classList.add('botaodropdown');
            selectServidores.appendChild(button);
        });
    }

    function inserir(id) {
        vetor.push(id);
        console.log(vetor);
        sessionStorage.servidorSelecionado = selectedServer
    }

    // Chamar a fun√ß√£o exibirServidoresUsuario
    exibirServidoresUsuario();



    let proximaAtualizacao;

    var idUsuario = sessionStorage.banco1
    var idUsuarioCPU = sessionStorage.servidor_id1
    var idUsuarioRAM = sessionStorage.servidor_id1
    var idUsuarioDISK = sessionStorage.servidor_id1

    window.onload = percentCPU(idUsuarioCPU),
        percentRAM(idUsuarioRAM),
        percentDISK(idUsuarioDISK);

    percentCPU(idUsuarioCPU)
    percentRAM(idUsuarioRAM)
    percentDISK(idUsuarioDISK)


    function Plano() {
        const planoContratado = sessionStorage.fkPlano;
        const nomePlano = document.getElementById('nomePlano');
        if (planoContratado != 1) {
            nomePlano.innerHTML = '<span id="planoUsuario">Plano Basico</span>';
        } else {
            nomePlano.innerHTML = '<span id="planoUsuario">Plano Premium</span>';
        }
    }


    function VerificarServidor() {
        var planoContratado = sessionStorage.fkPlano;
        if (planoContratado != 1) {
            var blocoRede = document.querySelector('.blocoRede');
            var blocoUsb = document.querySelector('.blocoUsb');
            if (blocoRede) {
                blocoRede.style.display = 'none';
            }
            if (blocoUsb) {
                blocoUsb.style.display = 'none';
            }
        }
    }



    document.addEventListener("DOMContentLoaded", function () {
        ContasAdministradas(sessionStorage.FKBANCO);
    });
    window.onload = ContasAdministradas(sessionStorage.FKBANCO);


    var vetorNivel = []
    var vetorEmail = []
    var CargoNivel = []



    idUsuario = sessionStorage.ID_USUARIO;
    nomeAdm.innerHTML = sessionStorage.NOME_USUARIO;



    function adicionar() {
        window.location = "servidor.html"
    }


    function ContasAdministradas(idUsuarioServer) {
        if (sessionStorage.ID_USUARIO) {
            let idUsuario = sessionStorage.FKBANCO;
            console.log(idUsuario); document.addEventListener("DOMContentLoaded", function () { });
        }
        else { console.error("ID do usu√°rio n√£o encontrada no sessionStorage."); }
        fetch(`/medidas/SelectContas/${idUsuario}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    response.json()
                    .then(function (response) {
                        console.log(`Dados recebidos: GRaIFCO ${JSON.stringify(response)}`);
                        response.reverse(); MostrarsUltimosAlertas(response);
                    });
                } else { console.error('Nenhum dado encontrado ou erro na API'); }
            })
            .catch(function (error) {
                console.error(`Erro na obten√ß√£o dos dados p/ gr√°fico: ${error.message}`);
            });
    }

    function MostrarsUltimosAlertas(response) {
        console.log('Exibindo dados retornados:')
        var dadosMostrar = document.getElementById('colocar');
        dadosMostrar.innerHTML = ''; // Limpa o conte√∫do anterior antes de adicionar novos dados
        for (var i = 0; i < response.length; i++) {
            var registro = response[i];
            var email = registro.mail;
            var nivel = registro.Esca;
            var cargo = registro.Cargo;
            CargoNivel.push(cargo)
            vetorNivel.push(nivel); // Adiciona o valor de 'nivel' ao vetor
            vetorEmail.push(email); // Adiciona o valor de 'email' ao vetor
            console.log(vetorEmail)
            console.log(vetorNivel)
            var elemento = document.createElement('div');
            elemento.classList.add('colocar');
            var conteudo = `
        
        <div class="edicaoGerenciamentoContas">
            <a id="MostrarEmail" class="emailControle">${vetorEmail[i]} -  </a>
        <span id="MostrarNivel${i}" class="nivelAcesso"> ${CargoNivel[i]} - ${vetorNivel[i]}</span>
         <input class="inputContas" id="novoValor${i}" type="text">
        <button class="botaoEditarAcesso" onclick="editarAcesso(${i})">Editar</button>
        <button class="botaoEditarAcesso" onclick="excluirConta(${i})">Excluir</button>
        </div> 
    `;
            // <div class="imgsContas">
            //     <!-- <img class="imgEdicaoGerenciar" src="../assets/ü¶Ü icon _Edit_.png" alt="" class="alterar"> -->
            //     <!-- <img src="../assets/ü¶Ü icon _Delete_.png" alt="" class="deletar"><span>editar</span> -->
            // </div>
            elemento.innerHTML = conteudo;
            dadosMostrar.appendChild(elemento);

            if (i !== response.length - 1) {
                var linhaEspacamento = document.createElement('div');
                linhaEspacamento.classList.add('linhaEspacamento');
                linhaEspacamento.innerHTML = '<span></span>';
                dadosMostrar.appendChild(linhaEspacamento);
            }
        }
    }


    console.log(vetorEmail)



    function editarAcesso(i) {
        window.editarAcesso = function (i) {
            var novoValorInput = document.getElementById('novoValor' + i);
            var novoNivel = novoValorInput.value;
            if (novoNivel !== '') {
                console.log(vetorNivel)
                vetorNivel[i] = novoNivel; // Atualiza o vetor com o novo valor de n√≠vel
                console.log(vetorNivel)
                // Atualiza o conte√∫do da div correspondente
                var divNivel = document.getElementById('MostrarNivel' + i);
                divNivel.textContent = novoNivel; // Atualiza o texto da div de n√≠vel com o novo valor

                // Limpa o valor do input ap√≥s a edi√ß√£o
                novoValorInput.value = '';
            }
            var email = vetorEmail[i]

            fetch("/usuarios/atualizarAcesso", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    // crie um atributo que recebe o valor recuperado aqui
                    // Agora v√° para o arquivo routes/usuario.js
                    NovoNivel: novoNivel,
                    Email: email,
                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);
                    Swal.fire({
                icon: 'correct',
                title: 'Regarregue a pagina',
                text: `Edi√ß√£o feita com sucesso`,
            });
            window.location = 'GerenciarAcesso.html'
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);

                });

        }




    }
    function excluirConta(i) {
        if (i > -1) {
            var email = vetorEmail[i];
            var nivel = vetorNivel[i]
            fetch("/usuarios/excluirConta", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    Nivel: nivel,
                    Email: email,

                }),
            })
                .then(function (resposta) {
                    if (resposta.ok) {
                        // Removendo os valores do vetor
                        vetorNivel.splice(i, 1);
                        vetorEmail.splice(i, 1);
                        // Atualizando a lista
                        atualizarLista();
                        Swal.fire({
                icon: 'correct',
                title: 'Regarregue a pagina',
                text: `Edi√ß√£o feita com sucesso`,
            });
            window.location = 'GerenciarAcesso.html'

                    } else {
                        throw new Error("Erro ao excluir a conta.");
                    }
                })
                .catch(function (erro) {
                    console.error("Houve um erro ao tentar excluir a conta:", erro);
                });
        }


    }

    function atualizarLista() {
        var dadosMostrar = document.getElementById('colocar');
        dadosMostrar.innerHTML = '';

        for (var i = 0; i < vetorNivel.length; i++) {
            var elemento = document.createElement('div');
            elemento.classList.add('dadosUsuarios');
            var conteudo = `
            <a id="MostrarEmail" class="emailControle">${vetorEmail[i]}</a>
            <span id="MostrarNivel${i}" class="nivelAcesso">${CargoNivel[i]} - ${vetorNivel[i]}</span>
            <div class="edicaoGerenciamentoContas">
            <input class="inputContas" id="novoValor${i}" type="text">
            <button class="botaoEditarAcesso" onclick="editarAcesso(${i})">Editar</button>
            <button class="botaoEditarAcesso" onclick="excluirConta(${i})">Excluir</button>
            </div>
        `;
            // <div class="imgsContas">
            //         <!-- <img class="imgEdicaoGerenciar" src="../assets/ü¶Ü icon _Edit_.png" alt="" class="alterar"> -->
            //         <!-- <img src="../assets/ü¶Ü icon _Delete_.png" alt="" class="deletar"><span>editar</span> -->
            elemento.innerHTML = conteudo;
            dadosMostrar.appendChild(elemento);

            if (i !== vetorNivel.length - 1) {
                var linhaEspacamento = document.createElement('div');
                linhaEspacamento.classList.add('linhaEspacamento');
                linhaEspacamento.innerHTML = '<span></span>';
                dadosMostrar.appendChild(linhaEspacamento);
            }
        }
    }

    function limparSessonStorage() {
        sessionStorage.clear()
    }

</script>